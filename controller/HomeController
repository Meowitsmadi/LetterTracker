package controller;

import java.io.IOException;
import java.net.URL;
import java.sql.SQLException;
import java.util.Optional;
import java.util.ResourceBundle;

import application.Student;
import javafx.beans.property.SimpleStringProperty;
import javafx.beans.property.StringProperty;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.control.Alert;
import javafx.scene.control.Button;
import javafx.scene.control.ButtonType;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.text.Text;
import sql.AccessFunctions;

public class HomeController extends SceneController{
	@FXML private TableView<Student> ResultsTable;
	@FXML private Button sr;
	private ObservableList<Student> studentData;
	@FXML private TableColumn<Student, String> studentFNColumn;
	@FXML private TableColumn<Student, String> studentLNColumn;
	
	@FXML private Text ResultsLabel;
	public static Text staticResultsLabel;
	@FXML public TextField searchBar = new TextField("");
	public String searchedName;
	private StringProperty searchText = new SimpleStringProperty("");
	
	public void switchToResults(ActionEvent event) throws IOException, SQLException{
		ResultsLabel.setText("Results For: " + searchBar.getText());
		updateResults(event, searchBar.getText());
	}
	
	// updates the search label and table with the searched last name
	public void updateHomePage(ActionEvent event) throws IOException, SQLException{
		ResultsLabel.setText("Results For: " + searchBar.getText());
		ObservableList<Student> studentList = AccessFunctions.getData(searchedName);
		ResultsTable.setItems(studentList);
	}
	
	// updates the search table with the student
	public void updateResults(ActionEvent event, String input) throws IOException, SQLException{
		studentData = AccessFunctions.getData(input);
	    ResultsTable.setItems(studentData);
	}
	
	// deletes the selected student from the list view on the homepage and in the database
	public void DeleteEntry(ActionEvent event) throws SQLException, IOException {
		// get selected row
		ObservableList<Student> tableItems, selectedRow;
		tableItems = ResultsTable.getItems();
		selectedRow = ResultsTable.getSelectionModel().getSelectedItems();
		
		if(!selectedRow.isEmpty()) {
			int id = 0;
			Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
			alert.setTitle("Confirm Deletion");
			alert.setContentText("Delete the LOR for: " + searchedName + "?");
			Optional<ButtonType> result = alert.showAndWait();
			if (result.get() == ButtonType.OK)
			{
				for (Student student: selectedRow) //get ID of selected row
				{
					id = student.getId();
				}
				selectedRow.forEach(tableItems::remove); // remove from ResultsTable
				AccessFunctions.DeleteRecommendation(id); // remove from DB
			}
		}
	}
	
	// gets the selected student's id and switches to the editable scene of their letter of recommendation
	public void switchToEditLORScene(ActionEvent event) throws SQLException, IOException {
		ObservableList<Student> selectedRow = ResultsTable.getSelectionModel().getSelectedItems();
		if(!selectedRow.isEmpty()) {
			isEdit = true;
			ID = selectedRow.get(0).getId();
			student = AccessFunctions.getData(ID);
			root = FXMLLoader.load(getClass().getResource("/view/EditLOR.fxml"));
			changeScene(event);
		}
	}
	
	// gets the selected student's ID and switches to the viewable scene of their letter of recommendation
	@FXML
	public void switchToViewScene(ActionEvent event) throws SQLException, IOException {
		ObservableList<Student> selectedRow = ResultsTable.getSelectionModel().getSelectedItems();
		if(!selectedRow.isEmpty()) {
			ID = selectedRow.get(0).getId();
			student = AccessFunctions.getData(ID);
			root = FXMLLoader.load(getClass().getResource("/view/ViewLOR.fxml"));
			changeScene(event);
		}
	}
	
	// Method initializes the combo boxes in the Create New Recommendation page by populating them with their respective data from the database
		@Override
		public void initialize(URL location, ResourceBundle resources) {
	        
	        searchText.bind(searchBar.textProperty());
			searchBar.textProperty().addListener((observable, oldValue, newValue) -> {
			    searchedName = newValue;
			});
			
			studentFNColumn.setCellValueFactory(new PropertyValueFactory<>("FirstName"));
			studentLNColumn.setCellValueFactory(new PropertyValueFactory<>("LastName"));
			
		}
}

